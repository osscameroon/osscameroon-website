name: github scraper deploy

on:
#   push:
#     paths:
#       - .github/workflows/github-scraper-deploy.yaml
#       - scraper/github/**
#     branches:
#       - test-github-action
  pull_request:
    paths:
      - .github/workflows/github-scraper-deploy.yaml
      - scraper/github/**
    branches:
      - main

jobs:
    build:
      runs-on: ubuntu-latest
      defaults:
        run:
          working-directory: scraper/github
      steps:
      - uses: actions/checkout@v2
      - name: Set up Python 3.8
        uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Install pakages
        run: |
          sudo apt-get install virtualenv

      - name: Run unit tests
        run: |
          make test

      - name: Setup env variables
# multistring env variables check this out
# https://docs.github.com/en/free-pro-team@latest/actions/reference/workflow-commands-for-github-actions#multiline-strings
#

        run: |
          echo 'SCP_FILES=scraper/github/build.tar' >> $GITHUB_ENV

          echo 'SCP_TARGET<<EOF' >> $GITHUB_ENV
          cat ./deploy/target.txt >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV

          tar -cvf build.tar $(cat deploy/files.txt)

      - name: Copy file via scp
        uses: appleboy/scp-action@v0.1.0
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_DEPLOY_USERNAME }}
          passphrase: ${{ secrets.DROPLET_DEPLOY_SSH_PASSPHRASE }}
          key: ${{ secrets.DROPLET_DEPLOY_SSHKEY }}
          source: ${{ env.SCP_FILES }}
          target: ${{ env.SCP_TARGET }}
          overwrite: true
          use_insecure_cipher: true
          debug: true
